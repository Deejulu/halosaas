{% extends 'base.html' %}

{% block title %}Admin Dashboard - Restaurant SaaS{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Admin Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body py-4 text-white">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="display-5 mb-2">
                                <i class="fas fa-crown me-3"></i>Admin Dashboard
                            </h1>
                            <p class="lead mb-0">Platform Management & Analytics</p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <span class="badge bg-light text-dark fs-6 me-2">
                                <i class="fas fa-clock me-1"></i>{{ today_orders }} orders today
                            </span>
                            {% if pending_orders > 0 %}
                            <span class="badge bg-warning text-dark fs-6">
                                <i class="fas fa-exclamation-circle me-1"></i>{{ pending_orders }} pending
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Stats Row 1 -->
    <div class="row mb-3">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-start border-4 border-primary shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-xs text-uppercase text-muted fw-bold mb-1">Total Revenue</div>
                            <div class="h4 mb-0 fw-bold">₦{{ total_revenue|floatformat:0|default:"0" }}</div>
                            <small class="text-success"><i class="fas fa-arrow-up me-1"></i>₦{{ today_revenue|floatformat:0|default:"0" }} today</small>
                        </div>
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-money-bill-wave fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-start border-4 border-success shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-xs text-uppercase text-muted fw-bold mb-1">Total Orders</div>
                            <div class="h4 mb-0 fw-bold">{{ total_orders }}</div>
                            <small class="text-muted">{{ completed_orders }} completed, {{ cancelled_orders }} cancelled</small>
                        </div>
                        <div class="bg-success bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-shopping-bag fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-start border-4 border-info shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-xs text-uppercase text-muted fw-bold mb-1">Total Users</div>
                            <div class="h4 mb-0 fw-bold">{{ total_users }}</div>
                            <small class="text-success"><i class="fas fa-user-plus me-1"></i>{{ new_users_today }} today, {{ new_users_week }} this week</small>
                        </div>
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-users fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-start border-4 border-warning shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-xs text-uppercase text-muted fw-bold mb-1">Restaurants</div>
                            <div class="h4 mb-0 fw-bold">{{ total_restaurants }}</div>
                            <small class="text-muted">{{ active_restaurants }} active, {{ suspended_restaurants }} suspended</small>
                        </div>
                        <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-utensils fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Stats Row 2 - More Metrics -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card bg-light h-100">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                    <h5 class="mb-0">₦{{ avg_order_value|floatformat:0|default:"0" }}</h5>
                    <small class="text-muted">Avg Order Value</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-light h-100">
                <div class="card-body text-center">
                    <i class="fas fa-calendar-week fa-2x text-success mb-2"></i>
                    <h5 class="mb-0">₦{{ week_revenue|floatformat:0|default:"0" }}</h5>
                    <small class="text-muted">This Week Revenue</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-light h-100">
                <div class="card-body text-center">
                    <i class="fas fa-calendar-alt fa-2x text-info mb-2"></i>
                    <h5 class="mb-0">₦{{ month_revenue|floatformat:0|default:"0" }}</h5>
                    <small class="text-muted">This Month Revenue</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-light h-100">
                <div class="card-body text-center">
                    <i class="fas fa-shopping-cart fa-2x text-warning mb-2"></i>
                    <h5 class="mb-0">{{ all_active_carts|length }}</h5>
                    <small class="text-muted">Active Carts</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-bolt text-warning me-2 fs-5"></i>
                            <span class="fw-bold">Quick Actions:</span>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            <a href="{% url 'notifications_dashboard' %}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-bell me-1"></i>View Notifications
                                {% if pending_orders > 0 %}<span class="badge bg-danger ms-1">{{ pending_orders }}</span>{% endif %}
                            </a>
                            <a href="{% url 'analytics_dashboard' %}" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-chart-bar me-1"></i>Analytics
                            </a>
                            <a href="{% url 'add_restaurant' %}" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-plus me-1"></i>Add Restaurant
                            </a>
                            <a href="{% url 'promo_code_list' %}" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-tags me-1"></i>Promo Codes
                            </a>
                            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#exportModal">
                                <i class="fas fa-download me-1"></i>Export Data
                            </button>
                            <a href="{% url 'audit_log_list' %}" class="btn btn-outline-dark btn-sm">
                                <i class="fas fa-history me-1"></i>Audit Logs
                            </a>
                            <a href="{% url 'settings_dashboard' %}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-cog me-1"></i>Settings
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Management Tabs -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-white py-3">
                    <ul class="nav nav-tabs card-header-tabs" id="adminTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="users-tab" data-bs-toggle="tab" href="#users" role="tab">
                                <i class="fas fa-users me-2"></i>Manage Users ({{ total_users }})
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="owners-tab" data-bs-toggle="tab" href="#owners" role="tab">
                                <i class="fas fa-store me-2"></i>Owner Overview ({{ owner_overview|length }})
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="restaurants-tab" data-bs-toggle="tab" href="#restaurants"
                                role="tab">
                                <i class="fas fa-utensils me-2"></i>Manage Restaurants ({{ total_restaurants }})
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab">
                                <i class="fas fa-shopping-bag me-2"></i>Recent Orders ({{ recent_orders|length }})
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="carts-tab" data-bs-toggle="tab" href="#carts" role="tab">
                                <i class="fas fa-shopping-cart me-2"></i>Active Carts ({{ all_active_carts|length }})
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="adminTabsContent">
                        <!-- Users Management Tab - ENHANCED -->
                        <div class="tab-pane fade show active" id="users" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0">Platform Users by Role</h5>
                                <div>
                                    <span class="badge bg-primary me-2">Admins: {{ user_counts.admin }}</span>
                                    <span class="badge bg-success me-2">Owners: {{ user_counts.owner }}</span>
                                    <span class="badge bg-info">Customers: {{ user_counts.customer }}</span>
                                </div>
                            </div>

                            <!-- Search Bar -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="userSearchInput" placeholder="Search users by name or email...">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <!-- Admins -->
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 border-primary">
                                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                            <span><i class="fas fa-user-shield me-2"></i><strong>Admins</strong></span>
                                            <span class="badge bg-light text-dark">{{ user_counts.admin }}</span>
                                        </div>
                                        <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                                            <div class="list-group list-group-flush user-list" data-role="admin">
                                                {% for user in admin_users %}
                                                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center user-item" data-username="{{ user.username|lower }}" data-email="{{ user.email|lower }}">
                                                    <div>
                                                        <strong>{{ user.username }}</strong>
                                                        <br><small class="text-muted">{{ user.email }}</small>
                                                    </div>
                                                    <div class="btn-group btn-group-sm">
                                                        <span class="badge {{ user.is_active|yesno:'bg-success,bg-danger' }} me-2">{{ user.is_active|yesno:'Active,Inactive' }}</span>
                                                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#userDetailModal" data-user-id="{{ user.id }}" data-username="{{ user.username }}" data-email="{{ user.email }}" data-role="{{ user.role }}" data-is-active="{{ user.is_active }}" data-joined="{{ user.date_joined|date:'M d, Y' }}"><i class="fas fa-eye"></i></button>
                                                    </div>
                                                </div>
                                                {% empty %}
                                                <div class="list-group-item text-center text-muted py-4">No admins found</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Restaurant Owners -->
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 border-success">
                                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                            <span><i class="fas fa-user-tie me-2"></i><strong>Restaurant Owners</strong></span>
                                            <span class="badge bg-light text-dark">{{ user_counts.owner }}</span>
                                        </div>
                                        <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                                            <div class="list-group list-group-flush user-list" data-role="owner">
                                                {% for user in owner_users %}
                                                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center user-item" data-username="{{ user.username|lower }}" data-email="{{ user.email|lower }}">
                                                    <div>
                                                        <strong>{{ user.username }}</strong>
                                                        <br><small class="text-muted">{{ user.email }}</small>
                                                        <br><small class="text-primary"><i class="fas fa-store me-1"></i>{{ user.restaurant_set.count }} restaurant(s)</small>
                                                    </div>
                                                    <div class="btn-group btn-group-sm">
                                                        <span class="badge {{ user.is_active|yesno:'bg-success,bg-danger' }} me-2">{{ user.is_active|yesno:'Active,Inactive' }}</span>
                                                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#userDetailModal" data-user-id="{{ user.id }}" data-username="{{ user.username }}" data-email="{{ user.email }}" data-role="{{ user.role }}" data-is-active="{{ user.is_active }}" data-joined="{{ user.date_joined|date:'M d, Y' }}" data-restaurants="{{ user.restaurant_set.count }}"><i class="fas fa-eye"></i></button>
                                                    </div>
                                                </div>
                                                {% empty %}
                                                <div class="list-group-item text-center text-muted py-4">No restaurant owners found</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Customers -->
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 border-info">
                                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                            <span><i class="fas fa-user me-2"></i><strong>Customers</strong></span>
                                            <span class="badge bg-light text-dark">{{ user_counts.customer }}</span>
                                        </div>
                                        <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                                            <div class="list-group list-group-flush user-list" data-role="customer">
                                                {% for user in customer_users %}
                                                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center user-item" data-username="{{ user.username|lower }}" data-email="{{ user.email|lower }}">
                                                    <div>
                                                        <strong>{{ user.username }}</strong>
                                                        <br><small class="text-muted">{{ user.email }}</small>
                                                        <br><small class="text-info"><i class="fas fa-shopping-bag me-1"></i>{{ user.order_set.count }} orders</small>
                                                    </div>
                                                    <div class="btn-group btn-group-sm">
                                                        <span class="badge {{ user.is_active|yesno:'bg-success,bg-danger' }} me-2">{{ user.is_active|yesno:'Active,Inactive' }}</span>
                                                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#userDetailModal" data-user-id="{{ user.id }}" data-username="{{ user.username }}" data-email="{{ user.email }}" data-role="{{ user.role }}" data-is-active="{{ user.is_active }}" data-joined="{{ user.date_joined|date:'M d, Y' }}" data-orders="{{ user.order_set.count }}"><i class="fas fa-eye"></i></button>
                                                    </div>
                                                </div>
                                                {% empty %}
                                                <div class="list-group-item text-center text-muted py-4">No customers found</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Restaurant Owners Overview Tab -->
                        <div class="tab-pane fade" id="owners" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0"><i class="fas fa-store me-2"></i>Restaurant Owners Overview</h5>
                                <div>
                                    <span class="badge bg-success me-2">Active Owners: {{ owner_overview|length }}</span>
                                </div>
                            </div>
                            
                            {% if owner_overview %}
                            <div class="accordion" id="ownersAccordion">
                                {% for owner_data in owner_overview %}
                                <div class="accordion-item mb-3 border rounded shadow-sm">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#owner{{ owner_data.owner.id }}">
                                            <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                                <div>
                                                    <i class="fas fa-user-tie me-2 text-success"></i>
                                                    <strong>{{ owner_data.owner.username }}</strong>
                                                    <small class="text-muted ms-2">({{ owner_data.owner.email }})</small>
                                                </div>
                                                <div>
                                                    <span class="badge bg-primary me-2">{{ owner_data.restaurants|length }} Restaurant(s)</span>
                                                    <span class="badge bg-info me-2">{{ owner_data.total_orders }} Orders</span>
                                                    <span class="badge bg-warning text-dark me-2">{{ owner_data.active_carts }} Active Cart(s)</span>
                                                    <span class="badge bg-success">₦{{ owner_data.total_revenue }}</span>
                                                </div>
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="owner{{ owner_data.owner.id }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" data-bs-parent="#ownersAccordion">
                                        <div class="accordion-body">
                                            {% for rest_data in owner_data.restaurants %}
                                            <div class="card mb-3 border-start border-4 border-primary">
                                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="mb-0">
                                                            <i class="fas fa-utensils me-2 text-primary"></i>
                                                            <strong>{{ rest_data.restaurant.name }}</strong>
                                                        </h6>
                                                        <small class="text-muted">{{ rest_data.restaurant.address }}</small>
                                                    </div>
                                                    <div>
                                                        <span class="badge {{ rest_data.restaurant.is_active|yesno:'bg-success,bg-danger' }}">{{ rest_data.restaurant.is_active|yesno:'Active,Inactive' }}</span>
                                                        <a href="{% url 'manage_restaurant' rest_data.restaurant.id %}" class="btn btn-sm btn-outline-primary ms-2"><i class="fas fa-cog"></i></a>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <!-- Orders Section -->
                                                        <div class="col-md-6 mb-3">
                                                            <h6 class="border-bottom pb-2">
                                                                <i class="fas fa-shopping-bag me-2 text-info"></i>Orders 
                                                                <span class="badge bg-info">{{ rest_data.orders_count }}</span>
                                                                {% if rest_data.pending_orders > 0 %}
                                                                <span class="badge bg-warning text-dark">{{ rest_data.pending_orders }} Pending</span>
                                                                {% endif %}
                                                            </h6>
                                                            {% if rest_data.orders %}
                                                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                                                <table class="table table-sm table-hover mb-0">
                                                                    <thead class="table-light sticky-top">
                                                                        <tr>
                                                                            <th>Order#</th>
                                                                            <th>Customer</th>
                                                                            <th>Amount</th>
                                                                            <th>Status</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        {% for order in rest_data.orders %}
                                                                        <tr>
                                                                            <td><a href="{% url 'order_detail' order.id %}">#{{ order.id }}</a></td>
                                                                            <td>{{ order.customer_name|truncatechars:15 }}</td>
                                                                            <td>₦{{ order.total_price }}</td>
                                                                            <td><span class="badge bg-{% if order.status == 'completed' %}success{% elif order.status == 'pending' %}warning text-dark{% elif order.status == 'cancelled' %}danger{% else %}info{% endif %} small">{{ order.get_status_display }}</span></td>
                                                                        </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                            {% if rest_data.orders_count > 5 %}
                                                            <small class="text-muted">Showing 5 of {{ rest_data.orders_count }} orders</small>
                                                            {% endif %}
                                                            {% else %}
                                                            <p class="text-muted small mb-0"><i class="fas fa-info-circle me-1"></i>No orders yet</p>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        <!-- Active Carts Section -->
                                                        <div class="col-md-6 mb-3">
                                                            <h6 class="border-bottom pb-2">
                                                                <i class="fas fa-shopping-cart me-2 text-warning"></i>Active Carts
                                                                <span class="badge bg-warning text-dark">{{ rest_data.carts_count }}</span>
                                                            </h6>
                                                            {% if rest_data.carts %}
                                                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                                                <table class="table table-sm table-hover mb-0">
                                                                    <thead class="table-light sticky-top">
                                                                        <tr>
                                                                            <th>Customer</th>
                                                                            <th>Items</th>
                                                                            <th>Value</th>
                                                                            <th>Updated</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        {% for cart in rest_data.carts %}
                                                                        <tr>
                                                                            <td>{{ cart.customer.username }}</td>
                                                                            <td>{{ cart.total_items }}</td>
                                                                            <td>₦{{ cart.total_price }}</td>
                                                                            <td><small>{{ cart.updated_at|timesince }}</small></td>
                                                                        </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                            {% else %}
                                                            <p class="text-muted small mb-0"><i class="fas fa-info-circle me-1"></i>No active carts</p>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="border-top pt-2 mt-2">
                                                        <small class="text-muted">
                                                            <strong>Revenue:</strong> ₦{{ rest_data.revenue }} |
                                                            <strong>Created:</strong> {{ rest_data.restaurant.created_at|date:"M d, Y" }}
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-store fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Restaurant Owners Yet</h5>
                                <p class="text-muted">Restaurant owners and their data will appear here.</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Restaurants Management Tab - ENHANCED -->
                        <div class="tab-pane fade" id="restaurants" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0">All Platform Restaurants</h5>
                                <div>
                                    <span class="badge bg-success me-2">Active: {{ active_restaurants }}</span>
                                    <span class="badge bg-danger">Suspended: {{ suspended_restaurants }}</span>
                                </div>
                            </div>

                            {% if restaurants_with_owners %}
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Restaurant</th>
                                            <th>Owner</th>
                                            <th>Contact</th>
                                            <th>Status</th>
                                            <th>Orders</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
{% for restaurant in restaurants_with_owners %}
<tr>
<td>{{ restaurant.id }}</td>
<td><strong>{{ restaurant.name }}</strong>{% if restaurant.logo %}<img src="{{ restaurant.logo.url }}" alt="{{ restaurant.name }}" class="rounded-circle ms-2" width="30" height="30">{% endif %}<br><small class="text-muted">{{ restaurant.description|truncatewords:5 }}</small></td>
<td><strong>{{ restaurant.owner.username }}</strong><br><small class="text-muted">{{ restaurant.owner.email }}</small></td>
<td><small><i class="fas fa-phone me-1"></i>{{ restaurant.phone }}<br><i class="fas fa-envelope me-1"></i>{{ restaurant.email }}</small></td>
<td><span class="badge {{ restaurant.is_active|yesno:'bg-success,bg-danger' }}">{{ restaurant.is_active|yesno:'Active,Suspended' }}</span></td>
<td>{{ restaurant.order_set.count }}</td>
<td>{{ restaurant.created_at|date:"M d, Y" }}</td>
<td>
<div class="btn-group btn-group-sm">
<a href="{% url 'restaurant_detail' restaurant.slug %}" class="btn btn-outline-primary" target="_blank" title="View"><i class="fas fa-eye"></i></a>
<a href="{% url 'manage_restaurant' restaurant.id %}" class="btn btn-outline-warning" title="Edit Restaurant"><i class="fas fa-edit"></i></a>
<a href="{% url 'manage_menu' restaurant.id %}" class="btn btn-outline-success" title="Edit Menu"><i class="fas fa-utensils"></i></a>
<form action="{% url 'admin_toggle_restaurant' restaurant.id %}" method="post" class="d-inline">
{% csrf_token %}
<button type="submit" class="btn btn-outline-{{ restaurant.is_active|yesno:'secondary,success' }}" title="{{ restaurant.is_active|yesno:'Suspend,Activate' }} Restaurant" onclick="return confirm('Are you sure you want to {{ restaurant.is_active|yesno:'suspend,activate' }} this restaurant?')"><i class="fas fa-power-off"></i></button>
</form>
<form action="{% url 'admin_delete_restaurant' restaurant.id %}" method="post" class="d-inline">
{% csrf_token %}
<button type="submit" class="btn btn-outline-danger" title="Delete Restaurant" onclick="return confirm('⚠️ WARNING: This will permanently delete {{ restaurant.name }} and all its data including menu items, orders, etc. This cannot be undone! Are you sure?')"><i class="fas fa-trash"></i></button>
</form>
</div>
</td>
</tr>
{% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Restaurants Found</h5>
                                <p class="text-muted">Restaurants will appear here when owners create them.</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Orders Tab -->
                        <div class="tab-pane fade" id="orders" role="tabpanel">
                            <h5 class="mb-4">Recent Platform Orders</h5>
                            {% if recent_orders %}
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Restaurant</th>
                                            <th>Customer</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for order in recent_orders %}
                                        <tr>
                                            <td><strong>#{{ order.id }}</strong></td>
                                            <td>{{ order.restaurant.name }}</td>
                                            <td>
                                                {{ order.customer.username }}
                                                <br>
                                                <small class="text-muted">{{ order.customer_name }}</small>
                                            </td>
                                            <td>₦{{ order.total_price }}</td>
                                            <td>
                                                <span
                                                    class="badge bg-{% if order.status == 'completed' %}success{% else %}warning{% endif %}">
                                                    {{ order.get_status_display }}
                                                </span>
                                            </td>
                                            <td>{{ order.created_at|date:"M d, Y H:i" }}</td>
                                            <td>
                                                <a href="{% url 'order_detail' order.id %}"
                                                    class="btn btn-sm btn-outline-primary">
                                                    View
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Recent Orders</h5>
                                <p class="text-muted">Orders will appear here when customers place them.</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Active Carts Tab -->
                        <div class="tab-pane fade" id="carts" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Active Customer Carts</h5>
                                <span class="badge bg-warning text-dark fs-6">{{ all_active_carts|length }} Cart(s)</span>
                            </div>
                            
                            {% if all_active_carts %}
                            <div class="row">
                                {% for cart in all_active_carts %}
                                <div class="col-lg-6 col-xl-4 mb-4">
                                    <div class="card h-100 border-warning">
                                        <div class="card-header bg-warning bg-opacity-25 d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-user me-2"></i>
                                                <strong>{{ cart.customer.username }}</strong>
                                            </div>
                                            <small class="text-muted">{{ cart.updated_at|timesince }} ago</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <div>
                                                    <i class="fas fa-store me-1 text-primary"></i>
                                                    <strong>{{ cart.restaurant.name }}</strong>
                                                </div>
                                                <span class="badge bg-primary">{{ cart.total_items }} items</span>
                                            </div>
                                            
                                            <div class="border rounded p-2 bg-light" style="max-height: 150px; overflow-y: auto;">
                                                <table class="table table-sm table-borderless mb-0">
                                                    {% for item in cart.items.all %}
                                                    <tr>
                                                        <td class="py-1">
                                                            <small>{{ item.quantity }}x</small> {{ item.menu_item.name }}
                                                        </td>
                                                        <td class="text-end py-1">₦{{ item.total_price }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </table>
                                            </div>
                                            
                                            <div class="mt-3 pt-2 border-top d-flex justify-content-between align-items-center">
                                                <span class="text-muted">Cart Total:</span>
                                                <span class="h5 mb-0 text-success">₦{{ cart.total_price }}</span>
                                            </div>
                                        </div>
                                        <div class="card-footer bg-transparent">
                                            <small class="text-muted">
                                                <i class="fas fa-envelope me-1"></i>{{ cart.customer.email }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Active Carts</h5>
                                <p class="text-muted">Customer carts will appear here when they add items to cart.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Admin Actions - FIXED LINKS -->
    <div class="row">
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-tools fa-3x text-primary mb-3"></i>
                    <h5 class="card-title">Django Admin</h5>
                    <p class="card-text">Full backend control</p>
                    <a href="/admin/" class="btn btn-primary btn-block" target="_blank">Access</a>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-chart-bar fa-3x text-success mb-3"></i>
                    <h5 class="card-title">Analytics</h5>
                    <p class="card-text">Platform reports & insights</p>
                    <a href="{% url 'analytics_dashboard' %}" class="btn btn-success btn-block">View
                        Reports</a>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-cog fa-3x text-info mb-3"></i>
                    <h5 class="card-title">Settings</h5>
                    <p class="card-text">Platform configuration</p>
                    <a href="{% url 'settings_dashboard' %}" class="btn btn-info btn-block">Configure</a>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-bell fa-3x text-warning mb-3"></i>
                    <h5 class="card-title">Notifications</h5>
                    <p class="card-text">System alerts & messages</p>
                    <a href="{% url 'notifications_dashboard' %}" class="btn btn-warning btn-block">Check</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS for tabs -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // User Search Functionality
        const searchInput = document.getElementById('userSearchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                document.querySelectorAll('.user-item').forEach(item => {
                    const username = item.dataset.username || '';
                    const email = item.dataset.email || '';
                    if (username.includes(searchTerm) || email.includes(searchTerm)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // User Detail Modal Population
        const userDetailModal = document.getElementById('userDetailModal');
        if (userDetailModal) {
            userDetailModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const userId = button.dataset.userId;
                const username = button.dataset.username;
                const email = button.dataset.email;
                const role = button.dataset.role;
                const isActive = button.dataset.isActive === 'True';
                const joined = button.dataset.joined;
                const restaurants = button.dataset.restaurants || '0';
                const orders = button.dataset.orders || '0';
                
                document.getElementById('modalUsername').textContent = username;
                document.getElementById('modalEmail').textContent = email;
                document.getElementById('modalRole').textContent = role.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                document.getElementById('modalJoined').textContent = joined;
                document.getElementById('modalUserId').value = userId;
                document.getElementById('modalRoleSelect').value = role;
                
                // Status badge
                const statusBadge = document.getElementById('modalStatus');
                statusBadge.textContent = isActive ? 'Active' : 'Inactive';
                statusBadge.className = 'badge ' + (isActive ? 'bg-success' : 'bg-danger');
                
                // Toggle button
                const toggleBtn = document.getElementById('toggleUserBtn');
                toggleBtn.innerHTML = isActive ? '<i class="fas fa-ban me-1"></i>Deactivate' : '<i class="fas fa-check me-1"></i>Activate';
                toggleBtn.className = 'btn ' + (isActive ? 'btn-warning' : 'btn-success');
                document.getElementById('toggleUserForm').action = '{% url "admin_toggle_user" 0 %}'.replace('0', userId);
                
                // Change role form
                document.getElementById('changeRoleForm').action = '{% url "admin_change_user_role" 0 %}'.replace('0', userId);
                
                // Delete form
                document.getElementById('deleteUserForm').action = '{% url "admin_delete_user" 0 %}'.replace('0', userId);
                
                // Extra info
                const extraInfo = document.getElementById('modalExtraInfo');
                if (role === 'restaurant_owner') {
                    extraInfo.innerHTML = '<i class="fas fa-store me-1"></i>' + restaurants + ' Restaurant(s)';
                } else if (role === 'customer') {
                    extraInfo.innerHTML = '<i class="fas fa-shopping-bag me-1"></i>' + orders + ' Order(s)';
                } else {
                    extraInfo.innerHTML = '<i class="fas fa-shield-alt me-1"></i>Platform Administrator';
                }
            });
        }

        // Tab functionality
        var triggerTabList = [].slice.call(document.querySelectorAll('#adminTabs a'))
        triggerTabList.forEach(function (triggerEl) {
            var tabTrigger = new bootstrap.Tab(triggerEl)
            triggerEl.addEventListener('click', function (event) {
                event.preventDefault()
                tabTrigger.show()
            })
        });

        // Confirm delete
        document.getElementById('deleteUserForm')?.addEventListener('submit', function(e) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                e.preventDefault();
            }
        });
    });
</script>

<!-- User Detail Modal -->
<div class="modal fade" id="userDetailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fas fa-user me-2"></i>User Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalUserId">
                <div class="text-center mb-4">
                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                        <i class="fas fa-user fa-3x text-secondary"></i>
                    </div>
                    <h4 class="mt-3 mb-1" id="modalUsername"></h4>
                    <p class="text-muted mb-2" id="modalEmail"></p>
                    <span class="badge bg-success" id="modalStatus">Active</span>
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <small class="text-muted">Role</small>
                        <p class="mb-0 fw-bold" id="modalRole"></p>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Joined</small>
                        <p class="mb-0 fw-bold" id="modalJoined"></p>
                    </div>
                </div>
                
                <div class="bg-light rounded p-3 mb-3 text-center">
                    <span id="modalExtraInfo" class="text-primary fw-bold"></span>
                </div>
                
                <hr>
                
                <!-- Quick Actions -->
                <h6 class="mb-3"><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
                
                <!-- Toggle Status -->
                <form id="toggleUserForm" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" id="toggleUserBtn" class="btn btn-warning">
                        <i class="fas fa-ban me-1"></i>Deactivate
                    </button>
                </form>
                
                <!-- Change Role -->
                <div class="mt-3">
                    <form id="changeRoleForm" method="post" class="d-flex gap-2">
                        {% csrf_token %}
                        <select name="role" id="modalRoleSelect" class="form-select form-select-sm" style="width: auto;">
                            <option value="admin">Admin</option>
                            <option value="restaurant_owner">Restaurant Owner</option>
                            <option value="customer">Customer</option>
                        </select>
                        <button type="submit" class="btn btn-sm btn-primary">
                            <i class="fas fa-exchange-alt me-1"></i>Change Role
                        </button>
                    </form>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <form id="deleteUserForm" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash me-1"></i>Delete User
                    </button>
                </form>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        transition: transform 0.2s ease-in-out;
    }

    .card:hover {
        transform: translateY(-2px);
    }

    .table th {
        border-top: none;
        font-weight: 600;
    }

    .badge {
        font-size: 0.75rem;
    }

    .btn-group .btn {
        border-radius: 0.375rem;
    }

    .nav-tabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        font-weight: 500;
    }

    .nav-tabs .nav-link.active {
        border-bottom: 3px solid #007bff;
        background: transparent;
    }
    
    .user-item {
        transition: background-color 0.2s;
    }
    
    .user-item:hover {
        background-color: #f8f9fa;
    }
    
    .list-group-item {
        border-left: none;
        border-right: none;
    }
</style>

<!-- Export Data Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title"><i class="fas fa-download me-2"></i>Export Data</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">Select what data you want to export (CSV format):</p>
                
                <div class="list-group">
                    <a href="{% url 'export_users' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-users me-2 text-primary"></i>
                            <strong>All Users</strong>
                            <br><small class="text-muted">Export user list with roles and status</small>
                        </div>
                        <span class="badge bg-primary">{{ total_users }}</span>
                    </a>
                    <a href="{% url 'export_restaurants' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-utensils me-2 text-warning"></i>
                            <strong>All Restaurants</strong>
                            <br><small class="text-muted">Export restaurant data with owners</small>
                        </div>
                        <span class="badge bg-warning text-dark">{{ total_restaurants }}</span>
                    </a>
                    <a href="{% url 'export_orders' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-shopping-bag me-2 text-success"></i>
                            <strong>All Orders</strong>
                            <br><small class="text-muted">Export order history with commission details</small>
                        </div>
                        <span class="badge bg-success">{{ total_orders }}</span>
                    </a>
                    <a href="{% url 'export_revenue_report' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-chart-line me-2 text-info"></i>
                            <strong>Revenue Report</strong>
                            <br><small class="text-muted">Comprehensive financial report with commission breakdown</small>
                        </div>
                        <i class="fas fa-file-csv text-success fs-4"></i>
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Announcement Modal -->
<div class="modal fade" id="announcementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-bullhorn me-2"></i>Send Platform Announcement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="announcementForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Target Audience</label>
                        <div class="d-flex flex-wrap gap-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="targetAll" checked>
                                <label class="form-check-label" for="targetAll">All Users</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="targetOwners">
                                <label class="form-check-label" for="targetOwners">Restaurant Owners</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="targetCustomers">
                                <label class="form-check-label" for="targetCustomers">Customers</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Announcement Type</label>
                        <select class="form-select">
                            <option value="info">ℹ️ Information</option>
                            <option value="warning">⚠️ Warning</option>
                            <option value="success">✅ Success/Update</option>
                            <option value="promo">🎉 Promotion</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Subject</label>
                        <input type="text" class="form-control" placeholder="Enter announcement subject...">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Message</label>
                        <textarea class="form-control" rows="5" placeholder="Enter your announcement message..."></textarea>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="sendEmail">
                        <label class="form-check-label" for="sendEmail">
                            <i class="fas fa-envelope me-1"></i>Also send via email
                        </label>
                    </div>
                </form>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Note:</strong> This feature is a placeholder. Full announcement functionality with email integration coming soon!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="alert('Announcement feature coming soon!');">
                    <i class="fas fa-paper-plane me-1"></i>Send Announcement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Restaurant Detail Modal -->
<div class="modal fade" id="restaurantDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-store me-2"></i>Restaurant Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Loading restaurant details...</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}